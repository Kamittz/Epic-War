<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic War Chat - TraduÃ§Ã£o Ilimitada</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        body{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px}
        .container{width:100%;max-width:500px;background:rgba(255,255,255,0.98);border-radius:20px;box-shadow:0 25px 80px rgba(0,0,0,0.5);overflow:hidden;display:flex;flex-direction:column;height:90vh}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center}
        .header h1{font-size:1.5rem;margin-bottom:5px}
        .setup-panel{padding:25px;background:#f8f9fa;overflow-y:auto}
        .input-group{margin-bottom:20px}
        .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:0.95rem}
        .input-group input,.input-group select{width:100%;padding:14px;border:2px solid #dee2e6;border-radius:12px;font-size:1rem}
        .btn{width:100%;padding:16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:12px;font-size:1.1rem;font-weight:700;cursor:pointer;margin-top:10px}
        .chat-container{flex:1;display:none;flex-direction:column;background:#e5ddd5}
        .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center}
        .room-code{font-weight:bold;background:rgba(255,255,255,0.25);padding:5px 10px;border-radius:6px;cursor:pointer}
        .translation-status{font-size:0.7rem;color:#90EE90;margin-top:2px}
        .messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px}
        .message{max-width:85%;padding:12px;border-radius:18px;animation:pop 0.3s ease}
        @keyframes pop{from{opacity:0;transform:scale(0.8) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .message.own{align-self:flex-end;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-bottom-right-radius:4px}
        .message.other{align-self:flex-start;background:white;color:#212529;border-bottom-left-radius:4px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .message-header{font-size:0.75rem;margin-bottom:5px;opacity:0.9;display:flex;justify-content:space-between}
        .original-text{font-size:0.95rem;margin-bottom:4px;word-break:break-word}
        .translated-box{background:rgba(255,255,255,0.2);border-radius:10px;padding:8px;margin-top:8px;border-left:3px solid rgba(255,255,255,0.5);font-size:0.85rem;font-style:italic}
        .message.other .translated-box{background:#f0f0f0;border-left:3px solid #667eea;color:#495057}
        .input-area{background:white;padding:15px;display:flex;gap:10px;border-top:1px solid #e0e0e0}
        .message-input{flex:1;padding:14px;border:2px solid #dee2e6;border-radius:25px;font-size:1rem}
        .send-btn{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .system-message{text-align:center;padding:8px;color:#6c757d;font-size:0.8rem;font-style:italic;background:rgba(0,0,0,0.05);border-radius:15px;margin:5px 0}
        .offline-badge{background:#ff6b6b;color:white;padding:2px 8px;border-radius:10px;font-size:0.7rem;margin-left:5px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš”ï¸ Epic War Chat</h1>
            <p>TraduÃ§Ã£o Ilimitada & em Tempo Real</p>
        </div>
        
        <div class="setup-panel" id="setup">
            <div class="input-group">
                <label>ğŸ® Seu Nome:</label>
                <input type="text" id="username" placeholder="Ex: DragonSlayer" maxlength="20">
            </div>
            <div class="input-group">
                <label>ğŸŒ Seu Idioma:</label>
                <select id="userLanguage">
                    <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                    <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                    <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                    <option value="pl">ğŸ‡µğŸ‡± Polski</option>
                    <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
                    <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
                </select>
            </div>
            <div class="input-group">
                <label>ğŸ”‘ CÃ³digo da Sala:</label>
                <input type="text" id="roomCode" placeholder="Ex: WAR123 (mesmo para todos)">
            </div>
            <button class="btn" onclick="enterChat()">âš¡ Entrar no Chat</button>
            <p style="margin-top:15px;font-size:0.85rem;color:#6c757d;text-align:center;">
                ğŸ’¡ <strong>Dica:</strong> Use Chrome/Edge para traduÃ§Ã£o ilimitada e instantÃ¢nea!
            </p>
        </div>
        
        <div class="chat-container" id="chat">
            <div class="chat-header">
                <div>
                    Sala: <span class="room-code" id="displayRoom" onclick="copyCode()">---</span>
                    <div class="translation-status" id="transStatus">ğŸŸ¢ TraduÃ§Ã£o ativa</div>
                </div>
                <button onclick="leaveChat()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 10px;border-radius:5px;cursor:pointer">âœ•</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" class="message-input" id="msgInput" placeholder="Digite sua mensagem..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="send-btn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnry2LnNH0jSkr7e1Zm3MqJGl0wTtCp8s",
            authDomain: "epic-war-chat-f71eb.firebaseapp.com",
            databaseURL: "https://epic-war-chat-f71eb-default-rtdb.firebaseio.com",
            projectId: "epic-war-chat-f71eb",
            storageBucket: "epic-war-chat-f71eb.firebasestorage.app",
            messagingSenderId: "1000418236216",
            appId: "1:1000418236216:web:c28afbb8622f353c2593cd"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let myName = '', myLang = 'pt', roomId = '', messagesRef = null;
        let useBrowserTranslation = false;

        // Verificar suporte a traduÃ§Ã£o do navegador
        async function checkBrowserTranslation() {
            if ('translation' in window && 'createTranslator' in window.translation) {
                try {
                    const canTranslate = await window.translation.canTranslate({
                        sourceLanguage: 'en',
                        targetLanguage: myLang
                    });
                    if (canTranslate === 'readily' || canTranslate === 'after-download') {
                        useBrowserTranslation = true;
                        document.getElementById('transStatus').textContent = 'ğŸš€ TraduÃ§Ã£o ilimitada (Chrome/Edge)';
                        return true;
                    }
                } catch (e) {
                    console.log('Browser translation not available');
                }
            }
            document.getElementById('transStatus').textContent = 'âš¡ TraduÃ§Ã£o online (pode ter delay)';
            return false;
        }

        function enterChat() {
            myName = document.getElementById('username').value.trim();
            myLang = document.getElementById('userLanguage').value;
            roomId = document.getElementById('roomCode').value.trim().toUpperCase() || 'ROOM' + Math.floor(Math.random() * 10000);

            if (!myName) { alert('âš ï¸ Digite seu nome!'); return; }

            localStorage.setItem('epicwar_name', myName);
            localStorage.setItem('epicwar_lang', myLang);

            document.getElementById('setup').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            document.getElementById('displayRoom').textContent = roomId;

            checkBrowserTranslation();
            connectToRoom();
        }

        function connectToRoom() {
            messagesRef = ref(database, 'rooms/' + roomId + '/messages');
            
            onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                if (msg.sender !== myName) displayMessage(msg);
            });

            addSystemMessage('ğŸ‰ VocÃª entrou na sala ' + roomId + '!');
            addSystemMessage('ğŸ“¢ Compartilhe este cÃ³digo com seus amigos!');
            
            if (useBrowserTranslation) {
                addSystemMessage('ğŸš€ TraduÃ§Ã£o ilimitada ativa! Use Chrome/Edge para melhor experiÃªncia.');
            }
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            const messageData = { sender: myName, text: text, lang: myLang, timestamp: Date.now() };
            push(messagesRef, messageData);
            displayOwnMessage(text);
        }

        function displayOwnMessage(text) {
            const div = document.createElement('div');
            div.className = 'message own';
            div.innerHTML = `<div class="message-header"><span><b>${myName}</b> (${myLang})</span><span>${new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span></div><div class="original-text">${escapeHtml(text)}</div>`;
            document.getElementById('messages').appendChild(div);
            div.scrollIntoView({behavior: 'smooth'});
        }

        async function displayMessage(msg) {
            let translated = null;
            let usedMethod = '';
            
            if (msg.lang !== myLang) {
                // Tenta traduÃ§Ã£o do navegador primeiro (ILIMITADA)
                if (useBrowserTranslation) {
                    try {
                        const translator = await window.translation.createTranslator({
                            sourceLanguage: msg.lang,
                            targetLanguage: myLang
                        });
                        translated = await translator.translate(msg.text);
                        usedMethod = 'âš¡';
                    } catch (e) {
                        console.log('Browser translation failed, trying API...');
                    }
                }
                
                // Se falhar, tenta API online
                if (!translated) {
                    translated = await translateWithAPI(msg.text, msg.lang, myLang);
                    usedMethod = translated ? 'ğŸŒ' : '';
                }
            }

            const div = document.createElement('div');
            div.className = 'message other';
            
            let html = `<div class="message-header"><span><b>${escapeHtml(msg.sender)}</b> (${msg.lang})</span><span>${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span></div><div class="original-text">${escapeHtml(msg.text)}</div>`;
            
            if (translated && translated !== msg.text) {
                html += `<div class="translated-box">${usedMethod} ${escapeHtml(translated)}</div>`;
            } else if (msg.lang !== myLang && !translated) {
                html += `<div class="translated-box" style="opacity:0.6;">ğŸ”„ [Clique para traduzir no Google]</div>`;
                div.onclick = () => window.open(`https://translate.google.com/?sl=${msg.lang}&tl=${myLang}&text=${encodeURIComponent(msg.text)}`, '_blank');
                div.style.cursor = 'pointer';
            }
            
            div.innerHTML = html;
            document.getElementById('messages').appendChild(div);
            div.scrollIntoView({behavior: 'smooth'});
        }

        async function translateWithAPI(text, from, to) {
            // API 1: MyMemory (gratuita, 5000/dia)
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`, {timeout: 3000});
                const data = await response.json();
                if (data.responseStatus === 200 && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
            } catch (e) {}
            
            // API 2: Fallback para Google Translate scraper
            try {
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(text)}`);
                const data = await response.json();
                if (data && data[0] && data[0][0]) {
                    return data[0].map(item => item[0]).join('');
                }
            } catch (e) {}
            
            return null;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            document.getElementById('messages').appendChild(div);
            div.scrollIntoView({behavior: 'smooth'});
        }

        function copyCode() {
            navigator.clipboard.writeText(roomId);
            alert('ğŸ“‹ CÃ³digo ' + roomId + ' copiado!');
        }

        function leaveChat() {
            if (confirm('Sair da sala?')) location.reload();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onload = () => {
            const savedName = localStorage.getItem('epicwar_name');
            const savedLang = localStorage.getItem('epicwar_lang');
            if (savedName) document.getElementById('username').value = savedName;
            if (savedLang) document.getElementById('userLanguage').value = savedLang;
        };
        
        window.enterChat = enterChat;
        window.sendMessage = sendMessage;
        window.leaveChat = leaveChat;
        window.copyCode = copyCode;
    </script>
</body>
</html>
