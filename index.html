<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic War Chat</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        body{background:#0f1419;min-height:100vh;display:flex;justify-content:center;align-items:center}
        .container{width:100%;max-width:450px;height:100vh;background:#0f1419;display:flex;flex-direction:column;position:relative}
        
        /* Header */
        .header{background:#1f2937;padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #374151}
        .header-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:1.5rem}
        .header-info{flex:1}
        .header-title{color:#fff;font-size:1rem;font-weight:600}
        .header-status{color:#10b981;font-size:0.75rem;display:flex;align-items:center;gap:5px;margin-top:2px}
        .online-dot{width:8px;height:8px;background:#10b981;border-radius:50%}
        .header-actions{display:flex;gap:16px}
        .header-btn{color:#9ca3af;font-size:1.3rem;cursor:pointer;padding:5px}
        .header-btn:hover{color:#fff}
        
        /* Participants dropdown */
        .participants-dropdown{position:absolute;top:65px;left:16px;right:16px;background:#1f2937;border-radius:12px;padding:15px;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:none;z-index:100;max-height:200px;overflow-y:auto}
        .participants-dropdown.show{display:block}
        .participants-dropdown h4{color:#9ca3af;font-size:0.8rem;margin-bottom:10px;text-transform:uppercase}
        .participant-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #374151}
        .participant-item:last-child{border-bottom:none}
        .participant-flag{font-size:1.2rem}
        .participant-name{color:#fff;font-size:0.9rem;flex:1}
        .participant-status{width:8px;height:8px;background:#10b981;border-radius:50%}
        
        /* Messages */
        .messages{flex:1;overflow-y:auto;padding:10px;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%230f1419" width="400" height="400"/><circle fill="%231f2937" cx="50" cy="50" r="2" opacity="0.3"/></svg>')}
        
        .date-divider{text-align:center;margin:15px 0}
        .date-divider span{background:#1f2937;color:#9ca3af;font-size:0.7rem;padding:5px 12px;border-radius:15px}
        
        .message{max-width:85%;margin-bottom:8px;position:relative;animation:pop 0.2s ease}
        @keyframes pop{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
        
        .message.own{align-self:flex-end;margin-left:auto}
        .message.other{align-self:flex-start}
        
        .bubble{padding:10px 14px;border-radius:18px;position:relative;word-break:break-word}
        .message.own .bubble{background:#005c4b;color:#fff;border-bottom-right-radius:4px}
        .message.other .bubble{background:#1f2937;color:#fff;border-bottom-left-radius:4px}
        
        .sender-name{font-size:0.75rem;color:#667eea;margin-bottom:4px;font-weight:600}
        .message.own .sender-name{display:none}
        
        .message-text{font-size:0.95rem;line-height:1.4}
        .message-image{max-width:100%;border-radius:12px;margin-top:5px;cursor:pointer;max-height:300px;object-fit:cover}
        
        .translation-box{margin-top:8px;padding:8px 10px;background:rgba(0,0,0,0.2);border-radius:10px;border-left:3px solid #10b981}
        .message.other .translation-box{background:rgba(255,255,255,0.05);border-left:3px solid #667eea}
        .translation-text{font-size:0.85rem;color:#e5e7eb;font-style:italic;line-height:1.4}
        .translation-label{font-size:0.65rem;color:#9ca3af;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px}
        
        .message-meta{display:flex;align-items:center;justify-content:flex-end;gap:5px;margin-top:4px;font-size:0.7rem;opacity:0.7}
        
        .system-message{align-self:center;background:rgba(255,255,255,0.1);color:#9ca3af;padding:6px 12px;border-radius:15px;font-size:0.75rem;margin:10px 0;text-align:center;max-width:90%}
        
        /* Input */
        .input-area{background:#1f2937;padding:10px;display:flex;align-items:center;gap:10px;border-top:1px solid #374151}
        .input-btn{color:#9ca3af;font-size:1.4rem;cursor:pointer;padding:8px}
        .input-btn:hover{color:#fff}
        .input-wrapper{flex:1;background:#2d3748;border-radius:25px;padding:5px 15px;display:flex;align-items:center}
        .message-input{flex:1;background:transparent;border:none;color:#fff;font-size:0.95rem;outline:none;padding:8px 0}
        .message-input::placeholder{color:#6b7280}
        .send-btn{width:40px;height:40px;border-radius:50%;background:#005c4b;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;margin-left:5px}
        .send-btn:hover{background:#007a63}
        
        /* Setup */
        .setup-panel{flex:1;display:flex;flex-direction:column;justify-content:center;padding:30px;background:#0f1419}
        .setup-title{color:#fff;font-size:1.5rem;text-align:center;margin-bottom:30px}
        .input-group{margin-bottom:20px}
        .input-group label{display:block;color:#9ca3af;font-size:0.85rem;margin-bottom:8px;padding-left:5px}
        .input-group input,.input-group select{width:100%;padding:14px 18px;background:#1f2937;border:1px solid #374151;border-radius:12px;color:#fff;font-size:1rem;outline:none}
        .input-group input:focus,.input-group select:focus{border-color:#667eea}
        .enter-btn{width:100%;padding:16px;background:#005c4b;color:#fff;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;margin-top:20px}
        .enter-btn:hover{background:#007a63}
        
        /* Modal */
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal.active{display:flex}
        .modal img{max-width:100%;max-height:90vh;border-radius:8px}
        .modal-close{position:absolute;top:20px;right:20px;color:#fff;font-size:2rem;cursor:pointer}
        
        /* Notification */
        .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:12px 24px;border-radius:25px;z-index:1001;display:none;font-size:0.9rem}
        
        #fileInput{display:none}
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup -->
        <div class="setup-panel" id="setup">
            <h1 class="setup-title">‚öîÔ∏è Epic War Chat</h1>
            <div class="input-group">
                <label>Seu nome</label>
                <input type="text" id="username" placeholder="Ex: DragonSlayer" maxlength="20">
            </div>
            <div class="input-group">
                <label>Seu idioma</label>
                <select id="userLanguage">
                    <option value="pt">üáßüá∑ Portugu√™s</option>
                    <option value="en">üá∫üá∏ English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="it">üáÆüáπ Italiano</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>
            <div class="input-group">
                <label>C√≥digo da sala</label>
                <input type="text" id="roomCode" placeholder="Ex: WAR123">
            </div>
            <div class="input-group">
                <label>Senha (opcional)</label>
                <input type="password" id="roomPassword" placeholder="Sala p√∫blica">
            </div>
            <button class="enter-btn" onclick="enterChat()">Entrar no Chat</button>
        </div>
        
        <!-- Chat -->
        <div class="chat-container" id="chat" style="display:none;height:100vh;flex-direction:column">
            <!-- Header -->
            <div class="header">
                <div class="header-avatar">‚öîÔ∏è</div>
                <div class="header-info" onclick="toggleParticipants()">
                    <div class="header-title" id="roomTitle">Sala ---</div>
                    <div class="header-status">
                        <span class="online-dot"></span>
                        <span id="onlineText">online</span>
                    </div>
                </div>
                <div class="header-actions">
                    <span class="header-btn" onclick="leaveChat()">‚ãÆ</span>
                </div>
            </div>
            
            <!-- Participants Dropdown -->
            <div class="participants-dropdown" id="participantsDropdown">
                <h4>üë• Participantes Online</h4>
                <div id="participantsList"></div>
            </div>
            
            <!-- Messages -->
            <div class="messages" id="messages"></div>
            
            <!-- Input -->
            <div class="input-area">
                <span class="input-btn" onclick="document.getElementById('fileInput').click()">üìé</span>
                <input type="file" id="fileInput" accept="image/*" onchange="sendImage(this)">
                <div class="input-wrapper">
                    <input type="text" class="message-input" id="msgInput" placeholder="Mensagem" onkeypress="if(event.key==='Enter')sendMessage()">
                </div>
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <span class="modal-close">‚úï</span>
        <img id="modalImg" src="">
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnry2LnNH0jSkr7e1Zm3MqJGl0wTtCp8s",
            authDomain: "epic-war-chat-f71eb.firebaseapp.com",
            databaseURL: "https://epic-war-chat-f71eb-default-rtdb.firebaseio.com",
            projectId: "epic-war-chat-f71eb",
            storageBucket: "epic-war-chat-f71eb.firebasestorage.app",
            messagingSenderId: "1000418236216",
            appId: "1:1000418236216:web:c28afbb8622f353c2593cd"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let myName = '', myLang = 'pt', roomId = '', roomPass = '';
        let messagesRef = null, usersRef = null;
        let useBrowserTrans = false;
        let loadedMessages = new Set(); // Evitar duplicatas

        async function checkBrowserTrans() {
            if ('translation' in window && 'createTranslator' in window.translation) {
                const can = await window.translation.canTranslate({sourceLanguage:'en',targetLanguage:myLang});
                useBrowserTrans = (can === 'readily' || can === 'after-download');
            }
        }

        async function enterChat() {
            myName = document.getElementById('username').value.trim();
            myLang = document.getElementById('userLanguage').value;
            roomId = document.getElementById('roomCode').value.trim().toUpperCase() || 'ROOM' + Math.random().toString(36).substr(2,6);
            roomPass = document.getElementById('roomPassword').value;

            if (!myName) { showNotif('Digite seu nome!', 'error'); return; }

            // Verificar senha
            const passRef = ref(database, 'rooms/' + roomId + '/password');
            const snap = await get(passRef);
            const savedPass = snap.val();
            if (savedPass && savedPass !== roomPass) { showNotif('Senha incorreta!', 'error'); return; }
            if (!savedPass && roomPass) await set(passRef, roomPass);

            localStorage.setItem('epicwar_name', myName);
            localStorage.setItem('epicwar_lang', myLang);

            document.getElementById('setup').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            document.getElementById('roomTitle').textContent = 'Sala ' + roomId;

            await checkBrowserTrans();
            connect();
        }

        function connect() {
            messagesRef = ref(database, 'rooms/' + roomId + '/messages');
            usersRef = ref(database, 'rooms/' + roomId + '/users/' + myName);

            // Registrar presen√ßa
            set(usersRef, {name:myName, lang:myLang, online:true, lastSeen:Date.now()});
            onDisconnect(usersRef).update({online:false});

            // Atualizar lista de participantes
            onValue(ref(database, 'rooms/' + roomId + '/users'), snap => {
                const users = snap.val() || {};
                updateParticipantsList(users);
                
                // Contar apenas online=true
                const onlineCount = Object.values(users).filter(u => u.online).length;
                document.getElementById('onlineText').textContent = onlineCount + ' online';
            });

            // Carregar TODAS as mensagens (hist√≥rico completo)
            get(messagesRef).then(snapshot => {
                const messages = snapshot.val() || {};
                Object.entries(messages).forEach(([key, msg]) => {
                    if (!loadedMessages.has(key)) {
                        loadedMessages.add(key);
                        if (msg.sender !== myName) {
                            showMessage(msg);
                        }
                    }
                });
            });

            // Ouvir NOVAS mensagens em tempo real
            onChildAdded(messagesRef, snap => {
                const key = snap.key;
                const msg = snap.val();
                
                // Evitar mostrar mensagem duplicada
                if (!loadedMessages.has(key) && msg.sender !== myName) {
                    loadedMessages.add(key);
                    showMessage(msg);
                }
            });

            addSystem('üéâ Voc√™ entrou na sala ' + roomId);
        }

        function updateParticipantsList(users) {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            Object.entries(users).forEach(([id, user]) => {
                if (user.online) {
                    const div = document.createElement('div');
                    div.className = 'participant-item';
                    div.innerHTML = `
                        <span class="participant-flag">${getFlag(user.lang)}</span>
                        <span class="participant-name">${escapeHtml(user.name)}</span>
                        <span class="participant-status"></span>
                    `;
                    list.appendChild(div);
                }
            });
        }

        function toggleParticipants() {
            document.getElementById('participantsDropdown').classList.toggle('show');
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';

            const msgData = {
                type: 'text',
                sender: myName,
                text: text,
                lang: myLang,
                time: Date.now()
            };

            // Mostrar imediatamente na tela
            showMyMessage(text);
            
            // Enviar para Firebase
            push(messagesRef, msgData);
        }

        function sendImage(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 500000) { // Limite 500KB
                showNotif('Imagem muito grande! M√°x: 500KB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                const base64 = e.target.result;
                
                // Mostrar na tela primeiro
                showMyImage(base64);
                
                // Enviar para Firebase
                push(messagesRef, {
                    type: 'image',
                    sender: myName,
                    image: base64,
                    lang: myLang,
                    time: Date.now()
                });
                
                showNotif('üì∑ Imagem enviada', 'success');
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function showMyMessage(text) {
            const div = document.createElement('div');
            div.className = 'message own';
            div.innerHTML = `
                <div class="bubble">
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-meta">${timeNow()} ‚úì</div>
                </div>
            `;
            document.getElementById('messages').appendChild(div);
            scrollDown();
        }

        function showMyImage(base64) {
            const div = document.createElement('div');
            div.className = 'message own';
            div.innerHTML = `
                <div class="bubble">
                    <img src="${base64}" class="message-image" onclick="openModal('${base64}')">
                    <div class="message-meta">${timeNow()} ‚úì</div>
                </div>
            `;
            document.getElementById('messages').appendChild(div);
            scrollDown();
        }

        async function showMessage(msg) {
            // Verificar se j√° n√£o mostrou esta mensagem
            const existing = Array.from(document.querySelectorAll('.message')).find(m => 
                m.dataset.time == msg.time && m.dataset.sender == msg.sender
            );
            if (existing) return;

            let trans = null;
            
            if (msg.lang !== myLang && msg.type === 'text') {
                if (useBrowserTrans) {
                    try {
                        const t = await window.translation.createTranslator({sourceLanguage:msg.lang,targetLanguage:myLang});
                        trans = await t.translate(msg.text);
                    } catch(e) {}
                }
                if (!trans) trans = await transAPI(msg.text, msg.lang, myLang);
            }

            const div = document.createElement('div');
            div.className = 'message other';
            div.dataset.time = msg.time;
            div.dataset.sender = msg.sender;
            
            let content = '';
            if (msg.type === 'text') {
                content = `<div class="message-text">${escapeHtml(msg.text)}</div>`;
                if (trans && trans !== msg.text) {
                    content += `
                        <div class="translation-box">
                            <div class="translation-label">Traduzido</div>
                            <div class="translation-text">${escapeHtml(trans)}</div>
                        </div>
                    `;
                }
            } else if (msg.type === 'image') {
                content = `<img src="${msg.image}" class="message-image" onclick="openModal('${msg.image}')">`;
            }
            
            div.innerHTML = `
                <div class="sender-name">${escapeHtml(msg.sender)}</div>
                <div class="bubble">${content}</div>
            `;
            
            document.getElementById('messages').appendChild(div);
            scrollDown();
        }

        async function transAPI(text, from, to) {
            try {
                const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`);
                const d = await r.json();
                if (d.responseStatus === 200) return d.responseData.translatedText;
            } catch(e) {}
            return null;
        }

        function addSystem(text) {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            document.getElementById('messages').appendChild(div);
            scrollDown();
        }

        function scrollDown() {
            const m = document.getElementById('messages');
            m.scrollTop = m.scrollHeight;
        }

        function timeNow() {
            return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        function getFlag(lang) {
            const flags = {pt:'üáßüá∑',en:'üá∫üá∏',es:'üá™üá∏',fr:'üá´üá∑',de:'üá©üá™',it:'üáÆüáπ',ru:'üá∑üá∫',ja:'üáØüáµ',ko:'üá∞üá∑',zh:'üá®üá≥'};
            return flags[lang] || 'üåê';
        }

        function showNotif(text, type) {
            const n = document.getElementById('notification');
            n.textContent = text;
            n.style.background = type === 'error' ? '#ef4444' : '#10b981';
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        function openModal(src) {
            document.getElementById('modalImg').src = src;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function leaveChat() {
            if (confirm('Sair da sala?')) {
                if (usersRef) set(usersRef, {online:false});
                location.reload();
            }
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-info')) {
                document.getElementById('participantsDropdown').classList.remove('show');
            }
        });

        window.onload = () => {
            const n = localStorage.getItem('epicwar_name');
            const l = localStorage.getItem('epicwar_lang');
            if (n) document.getElementById('username').value = n;
            if (l) document.getElementById('userLanguage').value = l;
        };

        window.enterChat = enterChat;
        window.sendMessage = sendMessage;
        window.sendImage = sendImage;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.toggleParticipants = toggleParticipants;
        window.leaveChat = leaveChat;
    </script>
</body>
</html>
